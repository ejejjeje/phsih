<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Phishing Scanner Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>

<header>
  <div class="left-section">
    <div class="logo">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" />
      <button id="hamburger" class="menu-toggle" title="Menu">‚ò∞</button>
    </div>
  </div>

  <nav id="main-nav" class="nav-links">
    <a href="{{ url_for('scanner') }}" id="nav-scanner">URL and Domain Scanner</a>
    <a href="{{ url_for('block_page') }}" id="nav-blocking">Blocking</a>
    <a href="{{ url_for('dashboard') }}" id="nav-dashboard" class="active">Dashboard</a>
  </nav>

  <div class="profile">
    <nav class="notification-nav">
      <span class="bell" title="Notifications">
        üîî<span class="notif-badge" id="notif-count" style="display: none;">0</span>
      </span>
    </nav>

    {% if user %}
      <span id="nav-user">{{ user.username }}</span>
    {% else %}
      <span id="nav-user">Guest</span>
    {% endif %}

    <div class="dropdown">
      <button id="menu-btn" class="menu-btn" title="Menu">‚ãÆ</button>
      <div class="dropdown-content" id="dropdown-menu">
        <form method="POST" action="{{ url_for('logout') }}">
          <button type="submit">Log Out</button>
        </form>
      </div>
    </div>
  </div>
</header>

<div class="notification-panel" id="notification-panel" style="display: none;">
  <div class="panel-header">
    <h4>Notifications</h4>
    <button id="clear-notifications">Clear All</button>
  </div>
  <div class="panel-body" id="notification-list"></div>
</div>

<main class="container">
  <h1>Dashboard</h1>
  <div class="status-cards">
    <div class="card green">
      <p>Activity</p>
      <h2 id="scan-count">{{ scan_count }}</h2>
      <p>You scanned {{ scan_count }} websites today</p>
    </div>
    <div class="card red">
      <p>Blocked Threats</p>
      <h2 id="block-count">{{ block_count }}</h2>
      <p>{{ block_count }} phishing URLs/Domains were blocked today</p>
    </div>
    <div class="card yellow" id="alert-card">
      <p>Alerts</p>
      <h2 id="alert-status">Loading...</h2>
      <p id="alert-message">Fetching your latest result...</p>
    </div>

    <div class="card gray">
      <p>Blacklist Updates</p>
      <h2>Up to Date</h2>
      <p>Your phishing blacklist is updated</p>
    </div>
  </div>

  <section class="stats">
    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
      <h2>Phishing URLs and Domains Blocked</h2>
      <div class="filters" style="display:flex; gap:10px; flex-wrap:wrap;">
        <label for="yearFilter">Show:</label>
<select id="yearFilter">
  <option value="7d" selected>Last 7 Days</option>
  <option value="1m">Last 1 Month</option>
  <option value="1y">Last 1 Year</option>
</select>
      </div>
    </div>
    <!-- Chart container -->
<div id="chartWrapper" style="overflow-x:auto; white-space:nowrap; padding-bottom:10px; height: 300px;">
  <div id="chartInner" style="min-width:300px; height:100%;"> <!-- ‚úÖ inner wrapper full height -->
    <canvas id="blockedChart" style="height:100% !important; max-height:100% !important;"></canvas>
  </div>
</div>

  </section>
<br>
  <!-- üìä Scan History Section -->
  <section class="history">
    <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
      <h2>Scan History</h2>
      <div class="filters" style="display:flex; gap:10px; flex-wrap:wrap;">
        <label for="history-period"></label>
        <select id="history-period">
          <option value="7d">Last 7 Days</option>
          <option value="1m">Last 1 Month</option>
          <option value="1y">Last 1 Year</option>
        </select>
        <button id="clear-history-btn" class="btn-red">Clear History</button>
      </div>
    </div>

    <div class="table-container">
      <table class="responsive-table">
        <thead>
          <tr>
            <th>Source URL</th>
            <th>Domain</th>
            <th>IP Address</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% if history %}
            {% for row in history %}
            <tr>
              <td>{{ row.url }}</td>
              <td>{{ row.domain or "-" }}</td>
              <td>{{ row.ip_address or "-" }}</td>
              <td>
                <span class="status {{ row.result|lower }}">
                  {{ row.result.capitalize() if row.result else "Unknown" }}
                </span>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4">No scan history available.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>
</main>

<script>
const menuBtn = document.getElementById("menu-btn");
const dropdown = document.getElementById("dropdown-menu");
const hamburger = document.getElementById("hamburger");
const nav = document.getElementById("main-nav");

window.addEventListener("click", function (e) {
  if (!menuBtn.contains(e.target) && !dropdown.contains(e.target)) {
    dropdown.style.display = "none";
  }
});

menuBtn.addEventListener("click", function () {
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
});

hamburger.addEventListener("click", () => {
  nav.classList.toggle("visible");
});

function getTimeAgo(timestamp) {
  const now = new Date();
  const then = new Date(timestamp);
  const localThen = new Date(then.getTime() + (new Date().getTimezoneOffset() * -60000));
  const diffSec = Math.floor((now - localThen) / 1000);
  if (diffSec < 60) return 'just now';
  const mins = Math.floor(diffSec / 60);
  if (mins < 60) return `${mins} minute${mins !== 1 ? 's' : ''} ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs} hour${hrs !== 1 ? 's' : ''} ago`;
  const days = Math.floor(hrs / 24);
  return `${days} day${days !== 1 ? 's' : ''} ago`;
}

function updateNotificationsUI() {
  const panel = document.getElementById("notification-panel");
  const list = document.getElementById("notification-list");
  const badge = document.getElementById("notif-count");

  fetch('/get_notifications')
    .then(res => res.json())
    .then(data => {
      list.innerHTML = "";

      if (data.length > 0) {
        badge.style.display = "inline-block";
        badge.textContent = data.length;
      } else {
        badge.style.display = "none";
        panel.style.display = "none";
      }

      // ‚úÖ Latest notification is the first in the descending list
      const latestNote = data.length > 0 ? data[0] : null;
      updateAlertCard(latestNote);

      data.forEach(note => {
        const item = document.createElement("div");
        item.className = "notification-item";

        let icon = "‚ÑπÔ∏è INFO";
        let title = "Info";
        let desc = note.message;

        const msg = note.message.toLowerCase();
        if (msg.includes("result: safe")) {
          icon = "‚úÖ SAFE";
          title = "Safe";
          desc = "This site appears to be safe and no threats were detected.";
        } else if (msg.includes("result: phish")) {
          icon = "‚ö†Ô∏è ALERT";
          title = "ALERT";
          desc = "This site has been flagged as a phishing threat.";
        } else if (msg.includes("blocked")) {
          icon = "‚õî BLOCKED";
          title = "Blocked URL";
          desc = "This URL or domain has been manually blocked.";
        }

        item.innerHTML = `
          <small>${icon} <span class="time">${getTimeAgo(note.timestamp)}</span></small>
          <p><strong>${title}</strong><br>${desc}</p>
        `;
        list.appendChild(item);
      });
    })
    .catch(err => {
      console.error("Failed to load notifications:", err);
    });
}

function updateAlertCard(latestNote) {
  const alertStatus = document.getElementById("alert-status");
  const alertMessage = document.getElementById("alert-message");
  const alertCard = document.getElementById("alert-card");

  if (!latestNote) {
    alertStatus.textContent = "No Alerts";
    alertMessage.textContent = "You haven‚Äôt scanned any sites yet.";
    alertCard.className = "card yellow";
    return;
  }

  const msg = latestNote.message.toLowerCase();

  if (msg.includes("result: safe")) {
    alertStatus.textContent = "‚úÖ Safe!";
    alertMessage.textContent = "You recently visited a safe site.";
    alertCard.className = "card green";
  } else if (msg.includes("result: phish")) {
    alertStatus.textContent = "‚ö†Ô∏è Phishing Alert!";
    alertMessage.innerHTML = "A recent site was flagged as phishing.";
    alertCard.className = "card red";
  } else if (msg.includes("blocked")) {
    alertStatus.textContent = "‚õî Blocked";
    alertMessage.textContent = "You manually blocked a phishing URL.";
    alertCard.className = "card gray";
  } else {
    alertStatus.textContent = "‚ÑπÔ∏è Info";
    alertMessage.textContent = latestNote.message;
    alertCard.className = "card yellow";
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const bell = document.querySelector(".bell");
  const clearBtn = document.getElementById("clear-notifications");

  bell.addEventListener("click", () => {
    const panel = document.getElementById("notification-panel");
    panel.style.display = panel.style.display === "block" ? "none" : "block";
  });

  clearBtn.addEventListener("click", () => {
    fetch('/clear_notifications', { method: 'POST' }).then(() => {
      document.getElementById("notification-panel").style.display = "none";
      document.getElementById("notif-count").style.display = "none";
      document.getElementById("notification-list").innerHTML = "";
      updateAlertCard(null);
    });
  });

  // ‚úÖ Load notifications + alerts on page load
  updateNotificationsUI();

  // ‚è± Auto-refresh every 30s
  setInterval(updateNotificationsUI, 30000);
});

document.getElementById("clear-history-btn").addEventListener("click", () => {
  if (confirm("Are you sure you want to clear your scan history?")) {
    fetch('/clear_scan_history', { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          // Reload the page to update scan history
          location.reload();
        } else {
          alert("Failed to clear scan history.");
        }
      })
      .catch(err => console.error("Error clearing history:", err));
  }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let blockedChart;

async function loadChart(period="7d") {  // default is 7 days
  const res = await fetch(`/api/chart-data/${period}`);
  const { labels, data } = await res.json();

  const ctx = document.getElementById('blockedChart').getContext('2d');

  const chartInner = document.getElementById("chartInner");
  chartInner.style.minWidth = labels.length > 15 ? (labels.length * 60) + "px" : "900px";

  if (blockedChart) blockedChart.destroy();

  blockedChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Blocked URLs',
        data: data,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.3)',
        fill: true,
        tension: 0.3,
        pointRadius: 4,
        pointBackgroundColor: '#3b82f6',
        pointBorderColor: '#ffffff',
        pointHoverRadius: 6,
        pointHoverBackgroundColor: '#2563eb'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { autoSkip: false } },
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

// ‚úÖ Load default chart (last 7 days)
loadChart();

// Change filter dynamically
document.getElementById('yearFilter').addEventListener('change', e => {
  loadChart(e.target.value);
});
</script>

<script>
document.getElementById("history-period").addEventListener("change", async (e) => {
  const filter = e.target.value; // "7d", "1m", "1y"
  const tbody = document.querySelector(".responsive-table tbody");

  try {
    const res = await fetch(`/api/scan-history?filter=${filter}`);
    const data = await res.json();
    tbody.innerHTML = ""; // clear old rows

    if (data.history.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4">No scan history available.</td></tr>`;
      return;
    }

    data.history.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.url}</td>
        <td>${row.domain}</td>
        <td>${row.ip_address}</td>
        <td><span class="status ${row.result.toLowerCase()}">${row.result}</span></td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Failed to fetch scan history:", err);
  }
});
</script>


</script>

</body>
</html>
